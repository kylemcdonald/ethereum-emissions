<!--
  - "how many per transaction?"
  - separate out region distribution plot
  - add medium article? with contact sheet pic of pdf?
-->
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ethereum Emissions and Power</title>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js"
      integrity="sha512-cd6CHE+XWDQ33ElJqsi0MdNte3S+bQY819f7p3NUHgwQQLXSKjE4cPZTeGNI+vaxZynk1wVU3hoHmow3m089wA=="
      crossorigin="anonymous"></script>
  
    <style>
      * {
        font-family: sans-serif;
      }

      #container {
        margin: 1em;
      }
  
      select, button {
        margin: 0.1em;
        font-size: 1em;
      }
  
      .fullscreen {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
  
      #loading {
        position: fixed;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.5);
        font-size: 2em;
      }

      .box {
        margin: 0.5em;
        padding: 0.5em;
        font-size: 2em;
        width: auto;
        float: left;
        height: 2.5em;
        border-left: 1px solid black;
      }

      #plot {
        /* margin: 20px; */
      }

      .value {
        font-weight: bold;
      }

      a {
        color: black;
      }
    </style>
  </head>
  
  <body>
    <div id='container'>
      <h1>Ethereum Emissions and Power / <a href="https://twitter.com/kcimc">@kcimc</a></h1>
      <div id='buttons'>
        <select id="duration" onchange="repressButton()">
          <option value="annualized">Annualized</option>
          <option value="daily">Daily</option>
        </select>
      </div>
      <div id='plot'></div>
      <div id='loading' class='fullscreen'>Loading...</div>
      <div class="box">
        <span id="twh_per_year" class="value">...</span> Terawatt hours per year<br>
        <span id="current_gw" class="value">...</span> Gigawatts
      </div>
      <div class="box">
        <span id="mtco2_per_year" class="value">...</span> Megatons CO<sub>2</sub> per year<br>
        <span id="current_ktco2_per_day" class="value">...</span> Kilotons CO<sub>2</sub> per day
      </div>
      <h2 style="float:right"><a href="https://github.com/kylemcdonald/ethereum-emissions">GitHub</a></h2>
    </div>
  
    <script>
      function rowsToColumns(rows) {
        const columns = {};
        Object.keys(rows[0]).forEach(e => {
          columns[e] = [];
        });
        // reverse the data here... to handle the reversed data
        rows.forEach(row => {
          for (const [key, value] of Object.entries(row)) {
            columns[key].push(value);
          }
        })
        return columns;
      }

      function convert_ktco2_per_day_to_mtco2_per_year(x) {
        return (x * 365) / 1e3;
      }

      function convert_gw_to_twh_per_year(x) {
        return (x * 24 * 365) / 1e3;
      }
  
      // seems like this feature is not offered by plotly
      // https://github.com/plotly/plotly.js/issues/1876
      // https://community.plotly.com/t/update-y-axis-domain-when-zoomed-on-x-axis/2073/10
      function attachRelayout(elementId) {
        var myPlot = document.getElementById(elementId);
        var isUnderRelayout = false;
        myPlot.on('plotly_relayout', function (relayoutData) {
  
          if (isUnderRelayout != true) {
            isUnderRelayout = true;
  
            let start = relayoutData['xaxis.range[0]'].substring(0,10);
            let end = relayoutData['xaxis.range[1]'].substring(0,10);
            console.log(start, end);
  
            let highs = myPlot.data.map(data => {
              let xstart = data.x.map(e => e == start).indexOf(true);
              let xend = data.x.map(e => e == end).indexOf(true);
              if (xend == -1) {
                xend = data.x.length - 1;
              }
              if (xstart == -1) {
                xstart = 0;
              }
              if (xend < xstart) {
                [xstart, xend] = [xend, xstart];
              }
              let high = Math.max(...data.y.slice(xstart, xend));
              return high;
            })
  
            let low = 0;
            let high = Math.max(...highs);
  
            let update = { 'yaxis.range': [low, high] };
            Plotly.relayout(myPlot, update).then(() => { isUnderRelayout = false })
          }
        });
      }

      async function loadLowerBestUpper(options) {
        const elementId = 'plot';
        const loadingElt = document.getElementById('loading');
        loadingElt.style.display = '';
        
        const fn = options.filename;
        const title = options.title;
  
        const data = await d3.csv(fn);
        const columns = rowsToColumns(data);
        const index = 'Date';

        let traces = {};
        const x = columns[index];
        const units = options.units[options.mode];
        for (const [key, value] of Object.entries(columns)) {
          if (key == index) {
            continue;
          }
          let y = value.map(e => +e);
          if (options.mode == 'annualized') {
            y = y.map(e => options.annualizer(e));
          }
          const hovertemplate = '%{y:.2f}' + units + ' (' + key + ' estimate)<br>%{x}<extra></extra>';
          const trace = {
            x: x,
            y: y,
            showlegend: false,
            ticksuffix: 'suffix',
            showticksuffix: 'all',
            text: 'respondents',
            hovertemplate: hovertemplate,
            name: key + ' estimate',
            line: {color: 'transparent'},
          };
          traces[key] = trace;
        }

        const layout = {
          title: title,
          hovermode: 'closest',
          yaxis: {
            fixedrange: true,
            title: units
          },
          font: {
            family: 'sans-serif'
          },
          margin: {
            r: 0,
            l: 40,
            b: 20,
            t: 40,
          },
          dragmode: 'pan',
          // height: window.innerHeight
        };
  
        const config = {
          displaylogo: false,
          responsive: true,
          scrollZoom: true
        };

        traces['lower'].fill = 'tonexty';
        traces['lower'].fillcolor = 'rgba(0,0,0,1)';
        traces['best'].line.color = 'rgba(255,255,255,1)';
  
        traces = [
          traces['upper'],
          traces['lower'],
          traces['best']
        ];

        Plotly.newPlot(elementId, traces, layout, config).then(() => {
          loadingElt.style.display = 'none';
          attachRelayout(elementId);
        })
      }
  
      const options = {
        'Emissions': {
          filename: 'output/daily-ktco2.csv',
          title: {
            'daily': 'Ethereum Daily Emissions',
            'annualized': 'Ethereum Annualized Emissions',
          },
          units: {
            'daily': ' Kilotons CO<sub>2</sub> per day',
            'annualized': ' Megatons CO<sub>2</sub> per year'
          },
          annualizer: convert_ktco2_per_day_to_mtco2_per_year
        },
        'Power': {
          filename: 'output/daily-gw.csv',
          title: {
            'daily': 'Ethereum Power',
            'annualized': 'Ethereum Annualized Energy',
          },
          units: {
            'daily': ' Gigawatts',
            'annualized': ' Terawatt hours per year'
          },
          annualizer: convert_gw_to_twh_per_year
        },
        // 'Ethereum Region Distribution': {
        //   filename: 'output/region-totals-grouped.csv'
        // }
      };
  
      let currentKey = 'Emissions';
      function pressButton(key) {
        currentKey = key;
        const args = {...options[key]};
        if (document.getElementById('duration').value == 'annualized') {
          args.mode = 'annualized';
        } else {
          args.mode = 'daily';
        }
        args.title = args.title[args.mode];
        loadLowerBestUpper(args);
      }
  
      function repressButton() {
        pressButton(currentKey);
      }

      async function initializeAnnualized() {
        const daily_gw = await d3.csv('output/daily-gw.csv');
        const current_gw = +daily_gw[daily_gw.length - 1]['best'];
        document.getElementById('current_gw').innerText = current_gw.toFixed(2);
        const twh_per_year = convert_gw_to_twh_per_year(current_gw);
        document.getElementById('twh_per_year').innerText = twh_per_year.toFixed(1);
        const daily_ktco2 = await d3.csv('output/daily-ktco2.csv');
        const current_ktco2_per_day = +daily_ktco2[daily_ktco2.length - 1]['best'];
        document.getElementById('current_ktco2_per_day').innerText = current_ktco2_per_day.toFixed(1);
        const mtco2_per_year = convert_ktco2_per_day_to_mtco2_per_year(current_ktco2_per_day);
        document.getElementById('mtco2_per_year').innerText = mtco2_per_year.toFixed(2);
      }
  
      const buttons = document.getElementById('buttons');
      for (const key in options) {
        const button = document.createElement('button');
        button.innerText = key;
        button.onclick = () => { pressButton(key) };
        buttons.append(button);
      }
  
      repressButton();
      initializeAnnualized();
    </script>
  
  </body>
  </html>